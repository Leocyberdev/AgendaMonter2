{% extends "base.html" %}

{% block title %}Editar Reunião - Sistema de Reuniões{% endblock %}

{% block content %}
<div class="container">
    <div class="content-overlay">
        <div class="row">
            <div class="col-12">
                <h1 class="display-6 mb-4">
                    <i class="bi bi-pencil me-3"></i>Editar Reunião
                </h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ url_for('meetings.dashboard') }}">Dashboard</a></li>
                        <li class="breadcrumb-item"><a href="{{ url_for('meetings.my_meetings') }}">Minhas Reuniões</a></li>
                        <li class="breadcrumb-item active">Editar: {{ meeting.title }}</li>
                    </ol>
                </nav>
            </div>
        </div>
        
        <div class="row">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="bi bi-pencil-square me-2"></i>Editar Informações da Reunião
                        </h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" id="editMeetingForm">
                            {{ form.hidden_tag() }}
                            
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    {{ form.title.label(class="form-label") }}
                                    {{ form.title(class="form-control" + (" is-invalid" if form.title.errors else ""), placeholder="Ex: Reunião de Planejamento") }}
                                    {% if form.title.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.title.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    {{ form.description.label(class="form-label") }}
                                    {{ form.description(class="form-control", rows="3", placeholder="Descrição opcional da reunião") }}
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    {{ form.room_id.label(class="form-label") }}
                                    {{ form.room_id(class="form-select" + (" is-invalid" if form.room_id.errors else ""), id="roomSelect") }}
                                    {% if form.room_id.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.room_id.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                    <div id="roomAvailability" class="mt-2"></div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    {{ form.participants.label(class="form-label") }}
                                    <div class="border rounded p-3" style="max-height: 150px; overflow-y: auto;">
                                        {% for value, label in form.participants.choices %}
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="participants" value="{{ value }}" id="participant_{{ value }}" 
                                                   {% if form.participants.data and value in form.participants.data %}checked{% endif %}>
                                            <label class="form-check-label" for="participant_{{ value }}">
                                                {{ label }}
                                            </label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <div class="form-text">Selecione os participantes tocando nas opções</div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    {{ form.start_datetime.label(class="form-label") }}
                                    {{ form.start_datetime(class="form-control" + (" is-invalid" if form.start_datetime.errors else ""), id="startDateTime") }}
                                    {% if form.start_datetime.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.start_datetime.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    {{ form.end_datetime.label(class="form-label") }}
                                    {{ form.end_datetime(class="form-control" + (" is-invalid" if form.end_datetime.errors else ""), id="endDateTime") }}
                                    {% if form.end_datetime.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.end_datetime.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            {% if meeting.is_recurring %}
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <div class="card border-warning">
                                        <div class="card-header bg-warning text-dark">
                                            <h6 class="mb-0">
                                                <i class="bi bi-arrow-repeat me-2"></i>Reunião Recorrente
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            {{ form.edit_all_recurring.label(class="form-label") }}
                                            {{ form.edit_all_recurring(class="form-select") }}
                                            <div class="form-text">
                                                <i class="bi bi-info-circle me-1"></i>
                                                Escolha se as alterações devem ser aplicadas apenas a esta reunião ou a toda a série recorrente.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                            <div class="d-flex justify-content-between">
                                <a href="{{ url_for('meetings.my_meetings') }}" class="btn btn-secondary">
                                    <i class="bi bi-arrow-left me-1"></i>Voltar
                                </a>
                                
                                <div>
                                    <!-- Botão de cancelar reunião -->
                                    <form method="POST" 
                                          action="{{ url_for('meetings.cancel_meeting', meeting_id=meeting.id) }}" 
                                          style="display:inline;">
                                        <button type="submit" class="btn btn-danger"
                                                onclick="return confirm('Tem certeza que deseja cancelar esta reunião? Se for recorrente, todas as futuras também serão canceladas.')">
                                            <i class="bi bi-x-circle me-1"></i> Cancelar Reunião
                                        </button>
                                    </form>

                                    <!-- Botão de salvar alterações -->
                                    {{ form.submit(class="btn btn-warning") }}
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-info-circle me-2"></i>Informações Atuais
                        </h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Título:</strong></td>
                                <td>{{ meeting.title }}</td>
                            </tr>
                            <tr>
                                <td><strong>Sala:</strong></td>
                                <td>{{ meeting.room.name }}</td>
                            </tr>
                            <tr>
                                <td><strong>Data:</strong></td>
                                <td>{{ meeting.start_datetime.strftime('%d/%m/%Y') }}</td>
                            </tr>
                            <tr>
                                <td><strong>Horário:</strong></td>
                                <td>{{ meeting.start_datetime.strftime('%H:%M') }} - {{ meeting.end_datetime.strftime('%H:%M') }}</td>
                            </tr>
                            <tr>
                                <td><strong>Criado em:</strong></td>
                                <td>{{ meeting.created_at.strftime('%d/%m/%Y às %H:%M') }}</td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="bi bi-exclamation-triangle me-2"></i>Atenção
                        </h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2">
                                <i class="bi bi-info-circle text-info me-2"></i>
                                Alterações serão aplicadas imediatamente
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-envelope text-primary me-2"></i>
                                Participantes serão notificados das mudanças
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-calendar-check text-success me-2"></i>
                                Verifique a disponibilidade da sala
                            </li>
                        </ul>
                    </div>
                </div>
                
                {% if meeting.is_recurring %}
                <div class="card mt-3">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-arrow-repeat me-2"></i>Reunião Recorrente
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-2">
                            <strong>Tipo:</strong> 
                            {% if meeting.recurrence_type == 'daily' %}Diária
                            {% elif meeting.recurrence_type == 'weekly' %}Semanal
                            {% elif meeting.recurrence_type == 'monthly' %}Mensal
                            {% endif %}
                        </p>
                        <p class="mb-0">
                            <strong>Até:</strong> {{ meeting.recurrence_end.strftime('%d/%m/%Y') }}
                        </p>
                        <div class="alert alert-info mt-2 mb-0">
                            <small>
                                <i class="bi bi-info-circle me-1"></i>
                                Alterações afetam apenas esta ocorrência
                            </small>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const roomSelect = document.getElementById('roomSelect');
    const startDateTime = document.getElementById('startDateTime');
    const endDateTime = document.getElementById('endDateTime');
    const roomAvailability = document.getElementById('roomAvailability');
    
    // Check room availability
    function checkAvailability() {
        const roomId = roomSelect.value;
        const start = startDateTime.value;
        const end = endDateTime.value;
        
        if (roomId && start && end) {
            fetch(`/meetings/api/check_availability?room_id=${roomId}&start_datetime=${start}&end_datetime=${end}&exclude_meeting_id={{ meeting.id }}`)
                .then(response => response.json())
                .then(data => {
                    if (data.available) {
                        roomAvailability.innerHTML = '<div class="alert alert-success py-2"><i class="bi bi-check-circle me-1"></i>Sala disponível</div>';
                    } else {
                        let conflictInfo = data.conflicts.map(c => `${c.title} (${new Date(c.start).toLocaleTimeString()} - ${new Date(c.end).toLocaleTimeString()})`).join(', ');
                        roomAvailability.innerHTML = `<div class="alert alert-danger py-2"><i class="bi bi-exclamation-triangle me-1"></i>Conflito: ${conflictInfo}</div>`;
                    }
                })
                .catch(error => {
                    console.error('Erro ao verificar disponibilidade:', error);
                });
        } else {
            roomAvailability.innerHTML = '';
        }
    }
    
    // Add event listeners
    roomSelect.addEventListener('change', checkAvailability);
    startDateTime.addEventListener('change', checkAvailability);
    endDateTime.addEventListener('change', checkAvailability);
    
    // Check availability on page load
    checkAvailability();
});
</script>
{% endblock %}
